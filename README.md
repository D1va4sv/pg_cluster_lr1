# **Описание**
## **Архитектура**

Проект состоит из трёх виртуальных машин на базе операционной системы Kali Linux:

- Master;
- Replica;
- Arbiter.

На всех виртуальных машинах установлен PostgreSQL 16 версии.

На виртуальных машинах Master и Replica настроена синхронная репликация PostgreSQL, по принципу Master->Replica.

На каждой из трёх виртуальных машин работают программы-агенты, написанные на bash.

## **Принцип работы программ-агентов**
**Master**

На ВМ Master работает программа-агент, которая каждые 30 секунд (это время может варьироваться в зависимости от конкретных условий) проверяет доступность Arbiter с помощью утилиты netcat и доступность Replica с помощью pg_isready.

В случае, если у Master теряется связь с Arbiter или Replica, он не предпринимает никаких действий и работает в штатном режиме.

В случае же потери связи и с Arbiter и с Replica, программа-агент выполняет команду *systemctl stop postgresql*.

**Replica**

На ВМ Replica работает программа-агент, которая каждые 30 секунд (это время может варьироваться в зависимости от конкретных условий) проверяет доступность Arbiter с помощью утилиты netcat и доступность Master с помощью pg_isready. Помимо этого, в программе-агент реализована функция, позволяющая обращаться к Arbiter и узнавать у него о доступности Master.

Replica делает *promote* только в том случае, если и у нее и у Arbiter теряется связь с Master, в иных случаях, не предпринимает никаких действий.

**Arbiter**

На ВМ Arbiter работает программа-агент, которая проверяет доступность Replica с помощью pg_isready и доступность Master с помощью утилиты netcat. Проверка Master сопровождается выводом статуса его работы, который потом запрашивает Replica.

**Логирование и cron**

Программа-агент, работающая на Arbiter запускается при старте системы и функционирует как непрерывный процесс.

Программы-агенты, работающие на Master и Replica, стартуют раз в 30 секунд при помощи утилиты *cron*.

Работа каждой программы-агента сопровождается записями в файлы:

- master.log (Master);
- arbiter.log (Arbiter);
- failover.log (Replica).

## **Тестирование**
Для того, чтобы протестировать работу программ-агентов, достаточно потушить PostgreSQL на Master командой *systemctl stop postgresql*.

После этого произойдет автоматический promote базы данных на Replica и она станет доступной для записи.

<pre>su - postgres
psql -c "CREATE TABLE test_table2 (id INT, name TEXT);"</pre>
## **Настройка отказоустойчивости (ЛР2)**
Реализация ЛР2 проведена на стенде из ЛР1.
Производим настройку synchronous_commit. Эти настройки определяют, как PostgreSQL будет обрабатывать транзакции и синхронизировать данные между Primary и Standby базами данных. Функция execute_query выполняет запрос на вставку данных в базу и измеряет время выполнения запроса. В зависимости от времени выполнения, запрос считается успешным или ошибочным. Скрипт ведет лог успешных и неуспешных запросов, а также подсчитывает их количество. 
Standby база данных постоянно синхронизируется с Primary базой данных, чтобы иметь актуальные данные для обеспечения высокой доступности в случае сбоя Primary. 
Настройки synchronous_commit определяют, как быстро данные будут реплицироваться и насколько надежно это будет сделано. Более строгие настройки (remote_write, on, remote_apply) обеспечивают более высокую надежность данных, но могут замедлить операции записи. Менее строгие настройки (off, local) обеспечивают более быструю запись, но могут привести к потере данных в случае сбоя.
Система тестирования должна проверять корректность репликации и возможность потери данных при различных настройках synchronous_commit. Скрипт выполняет эту проверку, выполняя множество запросов и анализируя время выполнения и количество успешных/неуспешных запросов.
Система отказоустойчивости включает Primary и Standby базы данных, которые синхронизируются между собой для обеспечения высокой доступности данных. Настройки synchronous_commit определяют баланс между производительностью и надежностью данных. Скрипт выполняет тестирование различных настроек synchronous_commit, чтобы проверить корректность работы системы и возможность потери данных при отказах.
Скрипт запускает 1 миллион асинхронных запросов со случайной задержкой. Каждый запрос вставляет в таблицу одну запись со своим номером. Для этого используется функция execute_query, которая выполняет вставку и измеряет время выполнения запроса. В середине выполнения запросов симулируется отказ сетевого соединения между основной базой данных и репликой. Для этого используются команды отключения сетевого интерфейса на реплике. Это позволяет проверить, как система справляется с потерей связи между кластерами и продолжает ли основная база данных принимать запросы на запись.  После завершения выполнения всех запросов сетевое соединение восстанавливается, и проводится проверка целостности данных. Все строки из таблицы читаются и сравниваются с логом успешных вставок, чтобы убедиться, что все данные были корректно сохранены и реплицированы.
В ходе выполнения данного задания были развернуты и протестированы компоненты отказоустойчивого кластера PostgreSQL. Тестирование показало, как различные настройки synchronous_commit влияют на целостность данных при отказах сетевого соединения между кластерами. Результаты тестирования подтверждают, что более строгие настройки (remote_write, on, remote_apply) обеспечивают лучшую целостность данных, хотя и могут замедлить операции записи. В то время как менее строгие настройки (off, local) повышают производительность, но могут привести к потере данных при сбое.
